# Order Flow - Accept & Reject Documentation

## üìä Complete Order Flow Diagram

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     CUSTOMER UPLOAD DP PROOF                        ‚îÇ
‚îÇ                     Status: pending_dp                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  JASTIPER VALIDASI DP                               ‚îÇ
‚îÇ                  Status: awaiting_validation                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ                                              ‚îÇ
      ‚úÖ ACCEPT                                      ‚ùå REJECT
           ‚îÇ                                              ‚îÇ
           ‚ñº                                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Status: awaiting_final_     ‚îÇ            ‚îÇ   Status: rejected     ‚îÇ
‚îÇ          payment             ‚îÇ            ‚îÇ                        ‚îÇ
‚îÇ                              ‚îÇ            ‚îÇ  Actions:              ‚îÇ
‚îÇ  Actions:                    ‚îÇ            ‚îÇ  - Stock restored      ‚îÇ
‚îÇ  - Email sent with breakdown ‚îÇ            ‚îÇ  - Order cancelled     ‚îÇ
‚îÇ  - Magic link generated      ‚îÇ            ‚îÇ  - Customer notified   ‚îÇ
‚îÇ  - Customer notified         ‚îÇ            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                      (END)
           ‚îÇ
           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              CUSTOMER UPLOAD PELUNASAN PROOF                        ‚îÇ
‚îÇ              Uses magic link from email                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              JASTIPER VALIDASI PELUNASAN                            ‚îÇ
‚îÇ              Status: awaiting_final_validation                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ                                              ‚îÇ
      ‚úÖ ACCEPT                                      ‚ùå REJECT
           ‚îÇ                                              ‚îÇ
           ‚ñº                                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      Status: paid            ‚îÇ            ‚îÇ Status: awaiting_final_‚îÇ
‚îÇ      (COMPLETED)             ‚îÇ            ‚îÇ        payment         ‚îÇ
‚îÇ                              ‚îÇ            ‚îÇ                        ‚îÇ
‚îÇ  Actions:                    ‚îÇ            ‚îÇ  Actions:              ‚îÇ
‚îÇ  - Order marked as paid      ‚îÇ            ‚îÇ  - finalProofUrl = null‚îÇ
‚îÇ  - Customer notified         ‚îÇ            ‚îÇ  - finalPaidAt = null  ‚îÇ
‚îÇ  - Transaction complete      ‚îÇ            ‚îÇ  - Customer notified   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ  - Can upload again    ‚îÇ
         (END)                              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                     ‚îÇ
                                                     ‚îî‚îÄ> Loop back to
                                                         upload pelunasan
```

---

## üîÑ Detailed Flow Scenarios

### Scenario 1: Happy Path (All Accepted)

```
1. Customer uploads DP proof
   ‚îî‚îÄ> Status: pending_dp ‚Üí awaiting_validation

2. Jastiper reviews DP proof ‚úÖ ACCEPT
   ‚îî‚îÄ> Status: awaiting_validation ‚Üí awaiting_final_payment
   ‚îî‚îÄ> Email sent with:
       - Order breakdown (subtotal, ongkir, service fee, commission)
       - Magic link for final payment upload
       - Payment instructions

3. Customer clicks magic link, uploads final payment proof
   ‚îî‚îÄ> Status: awaiting_final_payment ‚Üí awaiting_final_validation

4. Jastiper reviews final proof ‚úÖ ACCEPT
   ‚îî‚îÄ> Status: awaiting_final_validation ‚Üí paid
   ‚îî‚îÄ> Order COMPLETE
```

**Timeline:** DP ‚Üí Validate DP ‚Üí Email ‚Üí Final Payment ‚Üí Validate Final ‚Üí PAID ‚úÖ

---

### Scenario 2: DP Rejected

```
1. Customer uploads DP proof
   ‚îî‚îÄ> Status: pending_dp ‚Üí awaiting_validation

2. Jastiper reviews DP proof ‚ùå REJECT
   ‚îî‚îÄ> Status: awaiting_validation ‚Üí rejected
   ‚îî‚îÄ> Actions:
       - Stock released and restored
       - Rejection reason saved
       - Customer notified via email/WhatsApp
       - Order CANCELLED
```

**Result:** Order ends at `rejected` status. Customer cannot proceed. ‚ùå

---

### Scenario 3: Final Payment Rejected

```
1-3. (Same as Happy Path until awaiting_final_validation)

4. Jastiper reviews final proof ‚ùå REJECT
   ‚îî‚îÄ> Status: awaiting_final_validation ‚Üí awaiting_final_payment
   ‚îî‚îÄ> Actions:
       - finalProofUrl = null (proof deleted)
       - finalPaidAt = null (timestamp cleared)
       - rejectionReason saved
       - Email sent with rejection reason and new magic link
       - Customer notified

5. Customer receives rejection email
   ‚îî‚îÄ> Email contains rejection reason
   ‚îî‚îÄ> Email contains new magic link (auto-generated, 7 days validity)
   ‚îî‚îÄ> Clicks magic link to re-upload correct proof
   ‚îî‚îÄ> Loop back to step 3
```

**Result:** Customer gets another chance to upload correct final payment proof. üîÑ

---

## üìã Status Reference Table

| Status | Description | Customer Action | Jastiper Action |
|--------|-------------|-----------------|-----------------|
| `pending_dp` | Waiting for DP proof | Upload DP proof | - |
| `awaiting_validation` | DP uploaded, pending review | Wait | Accept/Reject DP |
| `rejected` | DP rejected, order cancelled | - | - |
| `awaiting_final_payment` | DP approved, waiting for final payment | Upload final proof | - |
| `awaiting_final_validation` | Final proof uploaded, pending review | Wait | Accept/Reject final |
| `paid` | All payments verified, order complete | - | - |

---

## üõ°Ô∏è Key Features

### 1. **DP Rejection = Order Cancelled**
- Stock automatically restored
- No refund needed (DP never accepted)
- Clean cancellation

### 2. **Final Payment Rejection = Re-upload Opportunity**
- Proof deleted from database
- Customer can upload again
- Same magic link or new one can be generated
- Prevents permanent failure on payment disputes

### 3. **Separate Proof URLs**
- `dpProofUrl` - Permanent record of DP payment
- `finalProofUrl` - Can be cleared and re-uploaded if rejected
- Legacy `proofUrl` - Backward compatibility

### 4. **Non-blocking Email Notifications**
- Email failures don't break the flow
- Logged for debugging
- Customer can still proceed via dashboard

---

## üîê Security Considerations

1. **Magic Link Expiry:** 7 days
2. **Token Validation:** SHA256 hashing
3. **Challenge-Response:** Last 4 digits of WhatsApp
4. **One-time Use:** Token revoked after successful upload
5. **Ownership Verification:** Only trip owner can validate

---

## üìß Email Notifications

### After DP Validation (Accept):
```
Subject: Pesanan Divalidasi - {orderCode}

Content:
- Order breakdown with all fees
- Magic link for final payment upload
- Payment instructions
- Jastiper contact info
- Security notice about magic link
```

### After DP Rejection:
```
Subject: Pesanan Ditolak - {orderCode}

Content:
- Rejection reason
- Refund information (if applicable)
- Contact jastiper for clarification
```

### After Final Payment Rejection:
```
Subject: Bukti Pelunasan Ditolak - {orderCode}

Content:
- Rejection reason
- Order breakdown (for reference)
- Instructions to upload correct proof
- New magic link for re-upload (auto-generated)
- Checklist of required proof details
- Jastiper contact information
- Security notice about magic link
```

---

## üéØ Implementation Summary

### Backend Endpoints:
1. `POST /orders/:orderId/validate` - Validate DP
2. `POST /orders/:orderId/approve-final` - Validate final payment
3. `POST /api/upload/:orderId` - Upload proof (DP or final)

### Frontend Components:
1. Dashboard validation UI with accept/reject buttons
2. Toast notifications for user feedback
3. Badge colors for status visualization
4. Separate proof preview for DP vs final

### Database Fields:
- `dpProofUrl` - DP payment proof
- `finalProofUrl` - Final payment proof
- `dpPaidAt` - DP payment timestamp
- `finalPaidAt` - Final payment timestamp
- `validatedAt` - Validation timestamp
- `validatedBy` - Jastiper who validated
- `rejectionReason` - Reason if rejected

---

## ‚úÖ Testing Checklist

- [ ] Upload DP proof ‚Üí Accept ‚Üí Email received
- [ ] Upload DP proof ‚Üí Reject ‚Üí Stock restored
- [ ] Upload final proof ‚Üí Accept ‚Üí Status = paid
- [ ] Upload final proof ‚Üí Reject ‚Üí Can re-upload
- [ ] Magic link expiry works correctly
- [ ] Challenge-response verification works
- [ ] Toast notifications display correctly
- [ ] Email templates render properly
- [ ] All status transitions logged

---

**Last Updated:** 2025-11-26
**Version:** 1.0.0
