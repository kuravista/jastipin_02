# Credential Rotation Checklist

**Date:** December 8, 2025  
**Priority:** CRITICAL - Execute IMMEDIATELY

## ⚠️ Assumption: ALL credentials are compromised

After malware infection with root access, assume ALL credentials, keys, and secrets stored on the server have been exfiltrated.

## 1. Database Credentials

### PostgreSQL/Supabase
- [ ] Rotate Supabase project password
- [ ] Generate new Supabase service_role key
- [ ] Generate new Supabase anon key
- [ ] Update `.env` files (backend + frontend)
- [ ] Update environment variables in PM2/systemd
- [ ] Restart all services

**Location to update:**
```bash
/app/backend/.env
/app/frontend/.env.local
```

**Variables:**
```
DATABASE_URL
DIRECT_URL
SUPABASE_URL
SUPABASE_ANON_KEY
SUPABASE_SERVICE_ROLE_KEY
```

## 2. JWT Secrets

- [ ] Generate new JWT_SECRET
- [ ] Update in backend `.env`
- [ ] Force logout all users (invalidate existing tokens)
- [ ] Restart backend service

**Variables:**
```
JWT_SECRET
JWT_REFRESH_SECRET
```

## 3. API Keys

### External Services
- [ ] RajaOngkir API Key
- [ ] Payment Gateway Keys (Midtrans/Xendit)
- [ ] Email Service (SendGrid/AWS SES)
- [ ] SMS Gateway
- [ ] Cloud Storage (AWS S3/Google Cloud Storage)
- [ ] Any OAuth client secrets

**Variables to check:**
```bash
grep -r "API_KEY\|API_SECRET\|CLIENT_SECRET" /app/backend/.env
grep -r "API_KEY\|API_SECRET\|CLIENT_SECRET" /app/frontend/.env.local
```

## 4. SSH Keys

- [ ] Remove all unauthorized keys from `~/.ssh/authorized_keys`
- [ ] Generate new SSH keypair
- [ ] Update SSH key on GitHub/GitLab
- [ ] Update SSH key in CI/CD (GitHub Actions/GitLab CI)
- [ ] Disable password authentication in SSH config

```bash
# Check current authorized keys
cat ~/.ssh/authorized_keys

# Generate new key
ssh-keygen -t ed25519 -C "server-recovery-$(date +%Y%m%d)"

# Backup and replace
cp ~/.ssh/authorized_keys ~/.ssh/authorized_keys.backup
# Manually add only known good keys
```

## 5. GitHub/GitLab Tokens

- [ ] Revoke all Personal Access Tokens (PATs)
- [ ] Generate new PAT for deployments
- [ ] Update in CI/CD secrets
- [ ] Update in deployment scripts

## 6. Session Secrets

- [ ] Rotate session secret
- [ ] Clear all Redis sessions
- [ ] Force re-authentication for all users

```bash
# Clear Redis sessions
redis-cli FLUSHALL
```

## 7. OAuth Credentials

If using OAuth (Google, Facebook, etc.):
- [ ] Rotate OAuth client secrets in provider console
- [ ] Update in application `.env`
- [ ] Notify users to re-authorize if needed

## 8. SSL/TLS Certificates

- [ ] Check if private keys are compromised
- [ ] Revoke and reissue SSL certificates if needed
- [ ] Update Let's Encrypt certificates

## 9. Application-Specific Secrets

- [ ] Cookie signing secrets
- [ ] CSRF tokens secrets
- [ ] Encryption keys for sensitive data
- [ ] Any hardcoded secrets in code (audit required)

## 10. Monitoring & Alerting

- [ ] Reset monitoring dashboard credentials
- [ ] Update alerting webhooks
- [ ] Verify logging endpoints are secure

## 11. Third-Party Integrations

- [ ] WhatsApp Business API
- [ ] Social media API tokens
- [ ] Analytics platforms (Google Analytics, etc.)
- [ ] CDN credentials

## Rotation Script Template

```bash
#!/bin/bash
# Credential Rotation Script

# 1. Backup current credentials
cp /app/backend/.env /app/backend/.env.backup.$(date +%Y%m%d-%H%M%S)
cp /app/frontend/.env.local /app/frontend/.env.local.backup.$(date +%Y%m%d-%H%M%S)

# 2. Generate new secrets
NEW_JWT_SECRET=$(openssl rand -base64 64)
NEW_JWT_REFRESH_SECRET=$(openssl rand -base64 64)
NEW_SESSION_SECRET=$(openssl rand -base64 32)

echo "Generated new secrets:"
echo "JWT_SECRET=$NEW_JWT_SECRET"
echo "JWT_REFRESH_SECRET=$NEW_JWT_REFRESH_SECRET"
echo "SESSION_SECRET=$NEW_SESSION_SECRET"

# 3. MANUALLY update .env files with new secrets
# 4. MANUALLY rotate external API keys in provider dashboards
# 5. Restart services after updates
```

## Post-Rotation Verification

```bash
# 1. Test database connectivity
cd /app/backend && npx tsx src/test-db-connection.ts

# 2. Test authentication
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"testpass"}'

# 3. Verify external APIs
# Test each integration manually

# 4. Check application logs
tail -f /app/backend/logs/*.log
```

## User Communication

**Template email to users:**

```
Subject: Security Notice - Password Reset Required

Dear User,

As a precautionary security measure, we are requiring all users to reset their passwords.

Please visit [your-site]/reset-password to create a new password.

If you notice any suspicious activity on your account, please contact us immediately.

We apologize for any inconvenience.

Best regards,
Security Team
```

## Timeline

- **T+0 (NOW):** Rotate critical credentials (database, JWT, SSH)
- **T+1 hour:** Rotate external API keys
- **T+2 hours:** Complete full audit and rotation
- **T+4 hours:** Verify all services operational
- **T+24 hours:** Monitor for anomalies

## Notes

- DO NOT reuse old passwords/secrets
- Use strong random generation (64+ chars for secrets)
- Store new credentials securely (1Password/HashiCorp Vault)
- Document what was rotated and when
- Test each change before moving to next

## Verification Checklist

After rotation, verify:
- [ ] Application starts successfully
- [ ] Database connections work
- [ ] Authentication works
- [ ] External API calls succeed
- [ ] No old credentials in code/configs
- [ ] No credentials in git history
- [ ] Logs don't show authentication errors
- [ ] Users can access their accounts
