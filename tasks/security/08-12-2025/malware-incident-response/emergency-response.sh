#!/bin/bash
# Emergency Malware Response Script
# Date: December 8, 2025
# CRITICAL: Execute IMMEDIATELY

set -e

echo "=========================================="
echo "EMERGENCY MALWARE RESPONSE"
echo "Date: $(date)"
echo "=========================================="

# Create evidence directory
EVIDENCE_DIR="/root/incident-evidence-$(date +%Y-%m-%d-%H%M%S)"
mkdir -p "$EVIDENCE_DIR"

echo "[1/6] Collecting evidence..."

# Collect process information
ps aux > "$EVIDENCE_DIR/processes.txt"
ps -p 179300 -o pid,ppid,lstart,cmd > "$EVIDENCE_DIR/malware-process.txt" 2>&1 || true
lsof -p 179300 > "$EVIDENCE_DIR/malware-open-files.txt" 2>&1 || true
cat /proc/179300/cmdline > "$EVIDENCE_DIR/malware-cmdline.txt" 2>&1 || true
ls -la /proc/179300/exe > "$EVIDENCE_DIR/malware-exe.txt" 2>&1 || true
cat /proc/179300/maps > "$EVIDENCE_DIR/malware-memory-maps.txt" 2>&1 || true

# Network connections
netstat -tulpn > "$EVIDENCE_DIR/network-connections.txt" 2>&1 || true
ss -tulpn > "$EVIDENCE_DIR/socket-stats.txt" 2>&1 || true
ss -p | grep 179300 > "$EVIDENCE_DIR/malware-connections.txt" 2>&1 || true

# System state
cat /etc/ld.so.preload > "$EVIDENCE_DIR/ld-so-preload.txt" 2>&1 || true
ls -la /etc/data/ > "$EVIDENCE_DIR/etc-data-dir.txt" 2>&1 || true
find /app -name "linuxsys*" -ls > "$EVIDENCE_DIR/linuxsys-files.txt" 2>&1 || true

# Persistence mechanisms
crontab -l > "$EVIDENCE_DIR/root-crontab.txt" 2>&1 || true
cat /etc/crontab > "$EVIDENCE_DIR/etc-crontab.txt" 2>&1 || true
ls -la /etc/cron.d/ > "$EVIDENCE_DIR/cron-d.txt" 2>&1 || true
systemctl list-units --type=service --all > "$EVIDENCE_DIR/systemd-services.txt" 2>&1 || true

# Logs
journalctl --since "2025-12-08 07:00" > "$EVIDENCE_DIR/journal.txt" 2>&1 || true
tail -n 2000 /var/log/syslog > "$EVIDENCE_DIR/syslog.txt" 2>&1 || true
tail -n 2000 /var/log/auth.log > "$EVIDENCE_DIR/auth.txt" 2>&1 || true

echo "Evidence collected: $EVIDENCE_DIR"

echo "[2/6] Killing malware process..."
kill -9 179300 2>&1 || echo "Process already terminated"

echo "[3/6] Removing rootkit components..."
rm -f /etc/ld.so.preload
rm -rf /etc/data/
ldconfig

echo "[4/6] Searching for additional malware..."
find /tmp -type f -executable -ls > "$EVIDENCE_DIR/tmp-executables.txt"
find /dev/shm -type f -ls > "$EVIDENCE_DIR/shm-files.txt"
find /app -type f -name "*miner*" -o -name "*crypto*" -o -name "linuxsys*" > "$EVIDENCE_DIR/suspicious-files.txt"

echo "[5/6] Checking for backdoors..."
cat ~/.ssh/authorized_keys > "$EVIDENCE_DIR/ssh-keys.txt"
find /app -type f \( -name "*.php" -o -name "*.ts" -o -name "*.js" \) -exec grep -l "eval\|base64_decode\|exec\|Function(" {} \; > "$EVIDENCE_DIR/potential-backdoors.txt" 2>&1

echo "[6/6] Updating Next.js to patched version..."
cd /app/frontend
npm install next@16.0.7

echo "=========================================="
echo "IMMEDIATE ACTIONS COMPLETED"
echo "=========================================="
echo ""
echo "Evidence directory: $EVIDENCE_DIR"
echo ""
echo "CRITICAL NEXT STEPS:"
echo "1. Review all evidence files"
echo "2. Rotate ALL credentials (database, API keys, JWT secrets)"
echo "3. Check for unauthorized SSH keys"
echo "4. Review systemd services for persistence"
echo "5. Consider full server rebuild"
echo ""
echo "See incident-report.md for complete response plan"
echo "=========================================="
